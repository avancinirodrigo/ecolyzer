<!DOCTYPE html>
<html lang="en">
    <head>
    	<meta charset="utf-8">
        <title>Souce Codes</title>
        <style type="text/css">
        	body {
        		overflow-x: hidden;
        	}

			.wrapper {
				position: absolute;
			    width:100%;
			    margin: 0 auto;
			    height: 100%;
			    display: flex;
			}

			#to_source {
			    float:left;
/*			    width: 47%;
			    height: 96%;
			    background-color: #FFFFFF;
			    overflow:scroll;
			    margin-left: 2%;*/
			}

			#from_source {
			    float:right;
/*			    width: 47%;
			    height: 96%;
			    background-color: #EEE8AA;
			    overflow:scroll;
			    margin-left: 2%;*/
			}

			#to_source, #from_source {
			    width: 47%;
			    height: 96%;
			    background-color: #FFFFFF;
			    overflow:scroll;
			    margin-left: 2%;
			}

			/*#to_source op {
				border: 2px solid; 
			}*/

			mark {
			  /*background: red;*/
			  /*display: inline;*/
		/*	  width: 100%;*/
			  border: 2px solid;
			  color: red;
			}
        </style>
		<script src="https://code.jquery.com/jquery-latest.min.js"></script>
		<script src="https://cdn.jsdelivr.net/mark.js/8.6.0/jquery.mark.min.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
		<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/lang-lua.js"></script>
		<style type="text/css">
			pre.prettyprint
			{
			    border: 0px;
			}			

			ol.linenums
			{
			    margin-top: 0;
			    margin-bottom: 0;
			}	

			li.L0, li.L1, li.L2, li.L3, li.L4,
			li.L5, li.L6, li.L7, li.L8, li.L9 {
				background: none;
				color: #C0C0C0;
				list-style-type: decimal;
			}
		</style>
    </head>
    <body>
		<div class="wrapper">
			<div id="to_source">
				<h2><span>{{ to_fullpath }}</span></h2>
				<op></op>
				<src></src>
			</div>
			<div id="from_source">
				<h2><span>{{ from_fullpath }}</span></h2>
				<op></op>
				<src></src>
			</div>
		</div>		                                    
    </body>
</html>
<script type="text/javascript">

	function hasCode(line, code_elements) {
		for(var i = 0; i < code_elements.length; i++) {
			if((line.search(code_elements[i] + " = function") >= 0)
					|| (line.search("function " + code_elements[i]) >= 0))
				return code_elements[i];
		}
		return "";		
	}

	function hasCodeFrom(line, code_elements) {
		var regex = "[\\w]+[.:]";
		for(var i = 0; i < code_elements.length; i++) {
			if((line.search(regex + code_elements[i]) >= 0))
					 // || (line.search("." + code_elements[i]) >= 0))
				return code_elements[i];
		}
		return "";		
	}

	var to_source = {{ to_source|tojson }}
	var from_source = {{ from_source|tojson }}

	var to_source_lines = to_source.split("\n");
	console.log(to_source_lines);
	var from_source_lines = from_source.split("\n");	

	// to_source_view = to_source_view.replace(/(\t)/g, "&nbsp;&nbsp;&nbsp;&nbsp;");
	// //from_source_view = from_source_view.replace(/(\t)/g, "&nbsp;&nbsp;&nbsp;&nbsp;");

	// to_source_view = to_source_view.replace(/ /g, "&nbsp;")
	// //from_source_view = from_source_view.replace(/ /g, "&nbsp;")	

	var to_operations = "";
	var code_elements = {{ code_elements|safe }}
	for(var i = 0; i < code_elements.length; i++) {
		to_operations += "<a href=\"#to_" + code_elements[i] + "\">" + code_elements[i] + "</a><br>";	
	}

	$("#to_source").find("op").html(to_operations);

	var to_source_view = "<pre class=\"prettyprint lang-lua linenums\">";

	// var to_source_div = document.getElementById("to_source");
	for(var i = 0; i < to_source_lines.length; i++) {
		var line = to_source_lines[i];
		var code_element = hasCode(line, code_elements);
		if(code_element != "") {
			to_source_view += "<a name=\"to_" + code_element + "\"</a><mark>" + line + "</mark>\n";
		}
		else
			to_source_view += line + "\n";	
		//to_source_div.innerHTML += to_source_lines[i] + "<br>";
	}

	to_source_view += "</pre>"

	$("#to_source").find("src").html(to_source_view);

	// var from_operations
	// for(var i = 0; i < code_elements.length; i++) {
	// 	to_operations += "<a href=\"#to_" + code_elements[i] + "\">" + code_elements[i] + "</a><br>";	
	// }	

	var from_source_view = "<pre class=\"prettyprint lang-lua linenums\">";

	var from_code_elements = {};
	var from_operations = "";
	var from_operations_count = 0;
	for(var i = 0; i < from_source_lines.length; i++) {
		var line = from_source_lines[i];
		var code_element = hasCodeFrom(line, code_elements);
		if(code_element != "") {
			// if(!from_code_elements[code_element])
			// 	from_code_elements[code_element] = 0;
			from_operations_count += 1;
			var from_ref = "from_" + from_operations_count + code_element;
			from_source_view += "<a name=\"" + from_ref + "\"</a>"
								+ "<a href=\"#to_" + code_element + "\"><mark>" + line + "</mark></a>\n";
								// + < "\n";
								// "<a name=\"to_" + code_element + "\"</a><mark>" + line + "</mark>\n";
			from_operations += "<a href=\"#" + from_ref + "\">" 
								+ from_operations_count + ". " + code_element + "</a><br>";
		}
		else
			from_source_view += line + "\n";	
		//to_source_div.innerHTML += to_source_lines[i] + "<br>";
	}

	from_source_view += "</pre>";

	$("#from_source").find("op").html(from_operations);

	$("#from_source").find("src").html(from_source_view);	

	// var from_source_view;
	// for(var i = 0; i < from_source_lines.length; i++) {
	// 	from_source_view += from_source_lines[i] + "<br>";
	// }	

	// to_source = to_source.replace(/(\t)/g, "&nbsp;&nbsp;&nbsp;&nbsp;")
	// //to_source = to_source.replace(/ /g, "&nbsp;") // TODO: review
	// to_source = to_source.replace(/(\n)/g, "<br>")		

	// from_source = from_source.replace(/(\t)/g, "&nbsp;&nbsp;&nbsp;&nbsp;")
	// //from_source = from_source.replace(/ /g, "&nbsp;")
	// from_source = from_source.replace(/(\n)/g, "<br>")	
	
	// $("#to_source").find("p").html(to_source);
	// $("#from_source").find("p").html(from_source);	

	// var code_elements = {{ code_elements|safe }}

	// for(var i = 0; i < code_elements.length; i++) {
	// 	var from_regex = new RegExp("[:| ]" + code_elements[i] + "[(|{]");
	// 	$("#from_source").find("p").markRegExp(from_regex);

	// 	var to_regex1 = new RegExp(code_elements[i] + " = function");
	// 	var to_regex2 = new RegExp("function " + code_elements[i]);
	// 	$("#to_source").find("p").markRegExp(to_regex1);			
	// 	$("#to_source").find("p").markRegExp(to_regex2);			
	// }
</script>
